<!DOCTYPE html>
<html>

<head>
    <title>CCSR Experiment 1</title>
    <script src="https://unpkg.com/jspsych@7.3.1"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/extension-record-video@1.0.1/dist/index.browser.js"></script>
    <script src="https://unpkg.com/@jspsych/plugin-initialize-camera@1.0.1/dist/index.browser.js"></script>
    <script src="https://unpkg.com/@jspsych-contrib/extension-mediapipe-face-mesh@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-fullscreen@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-slider-response@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-preload@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-video-keyboard-response@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-text@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.2"></script>
    <script src="jsPsych/plugin-nextcloud-filedrop.js"></script>
    <script src="https://unpkg.com/jszip@3.10.1/dist/jszip.js"></script>
    <script src="https://unpkg.com/@jspsych/plugin-call-function@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-browser-check@1.0.2"></script>
    <script src="jsPsych/extension-unity.js"></script>
    <script src="jsPsych/plugin-moot.js"></script>
    <script src="jsPsych/plugin-close-unity.js"></script>
    <script src="jsPsych/plugin-calibration-camera.js"></script>
    <script src="https://unpkg.com/@jspsych/plugin-image-keyboard-response@1.1.2"></script>
    <script src="utils.js"></script>
    <link href="https://unpkg.com/jspsych@7.3.1/css/jspsych.css" rel="stylesheet" type="text/css" />

    <link href="experiment_1.css" rel="stylesheet" type="text/css" />
</head>

<body></body>

<script>

    // Parameters of current condition
    // The values give the probabilities
    var condition = {
        targetpattern_squares: Math.random() < 0.5,
        doppelgaenger_color_white: Math.random() < 0.5,
        doppelgaenger_up: Math.random() < 0.5,
        questionnaire_doppelgaenger_first: Math.random() < 0.5,
    }

    /* var condition = {
        targetpattern_squares: true,
        doppelgaenger_color_white: false,
        doppelgaenger_up: true,
        questionnaire_doppelgaenger_first: true
    } */

    // Global configuration parameters
    var experiment_config = {
        ////////////////////////////////////////
        // RECORDING OF LIVE-TRACKING PARAMETERS
        //
        // Should the animation parameters for the Doppelgaenger/Other be recorded?
        // Preferable to recodring of mediapipe tracking directly, because it 
        // reflects what the participants saw on the screen
        //
        record_doppelgaenger_animation: false, // <- CHANGE TO TRUE
        record_other_animation: false,
        record_mediapipe: false,
    }

    
    const jsPsych = initJsPsych({
        extensions: [
            {
                type: jsPsychUnityExtension,
                params: {
                    loaderUrl: "./moot/moot_online.loader.js",
                    dataUrl: "./moot/moot_online.data.unityweb",
                    frameworkUrl: "./moot/moot_online.framework.js.unityweb",
                    codeUrl: "./moot/moot_online.wasm.unityweb",
                    width: "800px",
                    height: "500px",
                    waitEvent: 'JSPsychUnityReadyEvent'
                }
            },
            {
                type: jsPsychExtensionMediapipeFacemesh,
                params: {
                    locateFile: (file) => {
                        return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
                    }
                }
            },
            { type: jsPsychExtensionRecordVideo },
        ],
        on_finish: function () {
            //window.location = "https://app.prolific.co/submissions/complete?cc=XXXXXXX" /// automatically redirect the participant to the completion URL prolific
             jsPsych.data.displayData('json');
             jsPsych.data.get().localSave('json', 'mydata.json');
            // FileSaver.saveAs(jsPsych.data.get().json(), "hello world.txt");
        }
    });

    //////////////////////////////////////////
    //////////////////////////////////////////
    //////////Add version information to data (16 balancing version)
    //////////////////////////////////////////
    jsPsych.data.addProperties({
        is_targetpattern_squares:condition.targetpattern_squares,
        is_doppelgaenger_color_white:condition.doppelgaenger_color_white,
        is_doppelgaenger_up:condition.doppelgaenger_up,
        is_questionnaire_doppelgaenger_first:condition.questionnaire_doppelgaenger_first
        });

        const initCamera = {
        type: jsPsychInitializeCamera,
        include_audio: false
    }

    const enter_fullscreen = {
        type: jsPsychFullscreen,
        fullscreen_mode: true,
        message: '<p>The experiment will switch to full screen mode when you press the button below, please leave it in full screen for the entire experiment</p>',
    }

    const exit_fullscreen = {
        type: jsPsychFullscreen,
        fullscreen_mode: false,
        delay_after: 0
    }

    const debug_condition = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: "<div><p>Please look at the</p><p><br>" + (condition.targetpattern_squares ? "SQUARES" : "TRIANGLES") + "</br></p><p></p></div>",
        //trial_duration: 1000,
        choice: ['ArrowRight'],
        prompt: "press right arrow key to continue"
    }


    ////////////////////////////////////////////
    ////////////////////////////////////////////
    ///////////close / unplug Unity plugin
    ////////////////////////////////////////////    
    var closeUnity = {
            type: jsPsychCloseUnityPlugin,
        }

    
    const moot_parameters = {
      doggelgaenger_col: condition.doppelgaenger_color_white
        ? "1,1,1"
        : "0,0,0",
      doggelgaenger_loc: condition.doppelgaenger_up ? "20,0,-10" : "-20,0,-10",
      doppelgaenger_target: condition.targetpattern_squares ? "SQ" : "TR",
      go_notarget_left: 4,
      go_notarget_right: 4,
      go_target_left: 4,
      go_target_right: 4,
      nogo_type1_target_left: 1,
      nogo_type1_target_right: 1,
      doppelgaenger_anim_rec: experiment_config.record_doppelgaenger_animation,
      other_anim_rec: experiment_config.record_other_animation,
      mimicry_first_target_left: 1, 
      mimicry_second_notarget_left: 1,
    }

    const moot = {
      type: jsPsychMootPlugin,
      moot_parameters: moot_parameters,
      extensions: [
        { type: jsPsychUnityExtension },
        { type: jsPsychExtensionRecordVideo },
        {
          type: jsPsychExtensionMediapipeFacemesh,
          params: {
            record: false,
          },
        },
      ],
    };

    const timeline = [
        initCamera,
        enter_fullscreen,
        debug_condition,
        moot
    ]


    jsPsych.run(timeline);
</script>

</html>
