<!DOCTYPE html>
<html>

<head>
    <title>CCSR Experiment 1</title>
    <script src="https://unpkg.com/jspsych@7.3.1"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/extension-record-video@1.0.1/dist/index.browser.js"></script>
    <script src="https://unpkg.com/@jspsych/plugin-initialize-camera@1.0.1/dist/index.browser.js"></script>
    <script src="https://unpkg.com/@jspsych-contrib/extension-mediapipe-face-mesh@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-fullscreen@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-slider-response@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-preload@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-video-keyboard-response@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-text@1.1.2"></script>
    <script src="jsPsych/plugin-nextcloud-filedrop.js"></script>
    <script src="https://unpkg.com/jszip@3.10.1/dist/jszip.js"></script>
    <script src="jsPsych/extension-unity.js"></script>
    <script src="jsPsych/plugin-moot.js"></script>
    <script src="utils.js"></script>
    <link href="https://unpkg.com/jspsych@7.3.1/css/jspsych.css" rel="stylesheet" type="text/css" />

    <link href="experiment_1.css" rel="stylesheet" type="text/css" />
</head>

<body></body>
<script>

    // Parameters of current condition
    // The values give the probabilities
    var condition = {
        targetpattern_squares: Math.random() < 0,
        doppelgaenger_color_white: Math.random() < 0,
        doppelgaenger_up: Math.random() < 1,
        questionnaire_doppelgaenger_first: Math.random() < 1,
    }

    var condition = {
        targetpattern_squares: true,
        doppelgaenger_color_white: false,
        doppelgaenger_up: true,
        questionnaire_doppelgaenger_first: true
    }

    // Global configuration parameters
    var experiment_config = {
        ////////////////////////////////////////
        // RECORDING OF LIVE-TRACKING PARAMETERS
        //
        // Should the animation parameters for the Doppelgaenger/Other be recorded?
        // Preferable to recodring of mediapipe tracking directly, because it 
        // reflects what the participants saw on the screen
        //
        record_doppelgaenger_animation: false, // <- CHANGE TO TRUE
        record_other_animation: false,
        record_mediapipe: false,
    }

    // The mapping of slides to html files
    const slides_names = {
        Slide_1: "slides/Slide_1.html",
        Slide_2: "slides/Slide_2.html",
        Slide_3: "slides/Slide_3.html",
        Slide_4: "slides/Slide_4.html",
        Slide_5: "slides/Slide_5.html",
        Slide_6: "slides/Slide_6.html",
        Slide_7: "slides/Slide_7.html",
        Slide_8: "slides/Slide_8.html",
        Slide_9: "slides/Slide_9.html",
        Slide_10: "slides/Slide_10_DT.html",
        Slide_11: "slides/Slide_11.html",
        Slide_12: "slides/Slide_12_DP_DT.html",
        Slide_13: "slides/Slide_13_DP_DT.html",
        Slide_14: "slides/Slide_14_DP_DT.html",
        Slide_15: "slides/Slide_15_DP.html",
        Slide_16: "slides/Slide_16.html",
        Slide_17: "slides/Slide_17.html",
        Slide_18: "slides/Slide_18.html",
        Slide_19: "slides/Slide_19.html",
        Slide_20: "slides/Slide_20.html",
        Slide_21: "slides/Slide_21.html",
        Slide_22: "slides/Slide_22.html",
        Slide_23: "slides/Slide_23.html",
        Slide_24: "slides/Slide_24_DT.html",
        Slide_25: "slides/Slide_25.html",
        Slide_26: "slides/Slide_26.html",
        Slide_27: "slides/Slide_27.html",
        Slide_28: "slides/Slide_28.html",
        Slide_29: "slides/Slide_29.html",
        Slide_30: "slides/Slide_30.html",
        Slide_31: "slides/Slide_31.html",
        Slide_32: "slides/Slide_32.html",
        Slide_33: "slides/Slide_33_DT.html",
        Slide_34: "slides/Slide_34.html",
        Slide_35: "slides/Slide_35.html",
        Slide_36: "slides/Slide_36.html",
        Slide_37: "slides/Slide_37.html",
        Slide_38: "slides/Slide_38.html",
        Slide_39: "slides/Slide_39.html",
        Slide_40: "slides/Slide_40.html",
        Slide_41: "slides/Slide_41_DP_DT.html",
        Slide_43: "slides/Slide_43_DP_DT.html",
        Slide_45: "slides/Slide_45_DP_DT.html",
        Slide_47: "slides/Slide_47_DP_DT.html",
        Slide_49: "slides/Slide_49_DP_DT.html",
        Slide_51: "slides/Slide_51_DP_DT.html",
        Slide_53: "slides/Slide_53_DP_DT.html",
        Slide_55: "slides/Slide_55_DP_DT.html",
        Slide_57: "slides/Slide_57_DP_DT.html",
        Slide_59: "slides/Slide_59.html",
        Slide_60: "slides/Slide_60_DP_DT.html",
        Slide_62: "slides/Slide_62_DP_DT.html",
        Slide_64: "slides/Slide_64_DP_DT.html",
        Slide_66: "slides/Slide_66_DP_DT.html",
        Slide_68: "slides/Slide_68.html",
        Slide_69: "slides/Slide_69.html",
        Slide_70: "slides/Slide_70.html",
        Slide_71: "slides/Slide_71.html",
        Slide_72: "slides/Slide_72.html",
        Slide_73: "slides/Slide_73.html",
        Slide_74: "slides/Slide_74.html",
        Slide_75: "slides/Slide_75.html",
        Slide_76: "slides/Slide_76.html",
        Slide_77: "slides/Slide_77.html",
        Slide_78: "slides/Slide_78.html",
        Slide_79: "slides/Slide_79.html",
        Slide_80: "slides/Slide_80.html",

    };
    const images_filenames = [
        "images/Slide_10_squares.png",
        "images/Slide_10_triangle.png",
        "images/Slide_11_squares.png",
        "images/Slide_11_triangle .png",
        "images/Slide_12_1_down_squares.png",
        "images/Slide_12_1_down_triangles.png",
        "images/Slide_12_1.png",
        "images/Slide_12_1_up_squares.png",
        "images/Slide_12_1_up_triangles.png",
        "images/Slide_12_2_down_squares.png",
        "images/Slide_12_2_down_triangles.png",
        "images/Slide_12_2.png",
        "images/Slide_12_2_up_squares.png",
        "images/Slide_12_2_up_triangles.png",
        "images/Slide_12_3.png",
        "images/Slide_12_4.png",
        "images/Slide_13_down.png",
        "images/Slide_13_up.png",
        "images/Slide_14_down_squares.png",
        "images/Slide_14_down_triangles.png",
        "images/Slide_14_up_squares.png",
        "images/Slide_14_up_triangles.png",
        "images/Slide_15_down_squares.png",
        "images/Slide_15_down_triangles.png",
        "images/Slide_15_up_squares.png",
        "images/Slide_15_up_triangles.png",
        "images/Slide_17.png",
        "images/Slide_18.png",
        "images/Slide_2.png",
        "images/Slide_3.png",
        "images/Slide_40_1.png",
        "images/Slide_40_2.png",
        "images/Slide_41_2.png",
        "images/Slide_41_black.png",
        "images/Slide_41_white.png",
        "images/Slide_4.png",
        "images/Slide_57.png",
        "images/Slide_59.png",
        "images/Slide_5.png",
        "images/Slide_6_1.png",
        "images/Slide_6_2.png",
        "images/Slide_6_3.png",
        "images/Slide_6_4.png",
        "images/Slide_68.png",
        "images/Slide_76.png",
        "images/Slide_80.png",
    ];
    const video_filenames = [
        "videos/north europ F03-Anger-Face Forward.mp4",
        "videos/north europ F03-Disgust-Face Forward.mp4",
        "videos/north europ F03-Fear-Face Forward.mp4",
        "videos/north europ F03-Joy-Face Forward.mp4",
        "videos/north europ F03-Pride-Face Forward.mp4",
        "videos/north europ F03-Sadness-Face Forward.mp4",
        "videos/north europ F03-Surprise-Face Forward.mp4",
    ];

    const warmup_videos_names = {
        video_1: "videos/north europ F03-Anger-Face Forward.mp4",
        video_2: "videos/north europ F03-Disgust-Face Forward.mp4",
        video_3: "videos/north europ F03-Fear-Face Forward.mp4",
        video_4: "videos/north europ F03-Joy-Face Forward.mp4",
        video_5: "videos/north europ F03-Pride-Face Forward.mp4",
        video_6: "videos/north europ F03-Sadness-Face Forward.mp4",
        video_7: "videos/north europ F03-Surprise-Face Forward.mp4",
    };
    // Placeholders/replacements
    const replacements = {
        "target": condition.targetpattern_squares ? "squares" : "triangles",
        "nontarget": condition.targetpattern_squares ? "triangles" : "squares",
        "position": condition.doppelgaenger_color_white ? condition.doppelgaenger_up ? "up" : "down" : condition.doppelgaenger_up ? "down" : "up",
        "Hatcolor": condition.doppelgaenger_color_white ? "white" : "black"
    }


    ////////////////////////////////////////////////////
    ////////////////////////////////////////////////////
    //// PREPARATION

    // Load the html files and replace placeholders
    var slides_content = prepare_html(slides_names, replacements);

    const jsPsych = initJsPsych({
        extensions: [
            {
                type: jsPsychUnityExtension,
                params: {
                    loaderUrl: "./moot/moot_online.loader.js",
                    dataUrl: "./moot/moot_online.data.unityweb",
                    frameworkUrl: "./moot/moot_online.framework.js.unityweb",
                    codeUrl: "./moot/moot_online.wasm.unityweb",
                    width: "800px",
                    height: "500px",
                    waitEvent: 'JSPsychUnityReadyEvent'
                }
            },
            {
                type: jsPsychExtensionMediapipeFacemesh,
                params: {
                    locateFile: (file) => {
                        return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
                    }
                }
            },
            { type: jsPsychExtensionRecordVideo },
        ],
        on_finish: function () {
            // jsPsych.data.displayData('json');
            jsPsych.data.get().localSave('json', 'mydata.json');
            // FileSaver.saveAs(jsPsych.data.get().json(), "hello world.txt");
        }
    });



    ////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////
    // CREATE TRIALS FROM PSYCHOPY PLUGINS

    ////////////////////////////////////////////////////
    ////////////////////////////////////////////////////
    //// INITIALIZATION, OTHER STUFF
    ////////////////////////////////////////////////////
    ////////////////////////////////////////////////////

    const preloadMedia = {
        type: jsPsychPreload,
        message: "Loading videos and images.",
        //auto_preload: true,
        images: images_filenames,
        videos: video_filenames,
        show_detailed_errors: true
    }
    const initCamera = {
        type: jsPsychInitializeCamera,
        include_audio: true
    }

    const enter_fullscreen = {
        type: jsPsychFullscreen,
        fullscreen_mode: true
    }

    const exit_fullscreen = {
        type: jsPsychFullscreen,
        fullscreen_mode: false,
        delay_after: 0
    }

    const debug_condition = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: "<div><p>Condition</p><p>" + JSON.stringify(condition, null, 2) + "</p></div>",
        //trial_duration: 1000,
        choice: ['ArrowRight'],
        prompt: "press right arrow key to continue"
    }

    var nextcloud_upload = {
        type: jsPsychNextcloudFiledropPlugin,
        url: 'https://owncloud.csl.uni-bremen.de',
        folder: 'cWgCPebx54Be4Ty:'
    }

    ////////////////////////////////////////////////////
    ////////////////////////////////////////////////////
    //// INTRODUCTION
    ////////////////////////////////////////////////////
    ////////////////////////////////////////////////////

    var allSlides = [];
    Object.keys(slides_content).forEach(key => {
        html = slides_content[key];

        allSlides.push({
            type: jsPsychHtmlKeyboardResponse,
            stimulus: html,
            prompt: "Press right arrow key for further instructions",
            choices: ['ArrowRight'],
        });

    });
    var generalInstructions = [];
    for (let i = 0; i < 6; i++) {
        generalInstructions.push(allSlides[i]);
    }
    generalInstructions[0].prompt = '<p>Press right arrow key for further instructions</p> <img alt="" src="images/right_arrow.png" width="75" height="50"/>';
    for (let i = 1; i < generalInstructions.length; i++) {
        generalInstructions[i].prompt = '<img alt="" src="images/right_arrow.png" width="75" height="50"/>';
    }

    var mainInstructions = [];
    for (let i = 9; i < 15; i++) {
        mainInstructions.push(allSlides[i]);
    }
    for (let i = 0; i < mainInstructions.length; i++) {
        mainInstructions[i].prompt = '<img alt="" src="images/right_arrow.png" width="75" height="50"/>';
    }
    var countDown = [];
    for (let i = 25; i < 30; i++) {
        countDown.push(allSlides[i]);

    }

    for (let i = 0; i < countDown.length; i++) {
        delete countDown[i].choices;
        delete countDown[i].prompt;
        countDown[i].trial_duration = 1500;
    }
    ////////////////////////////////////////////////////
    ////////////////////////////////////////////////////
    //// WARMUP
    ////////////////////////////////////////////////////
    ////////////////////////////////////////////////////

    const warmup_block = createWarumupTimeline();


    var summaryInstruction = allSlides[23];
    summaryInstruction.prompt = '<img alt="" src="images/right_arrow.png" width="75" height="50"/>';
    var practicePhaseStartInstruction = allSlides[24];
    delete practicePhaseStartInstruction.choices;
    delete practicePhaseStartInstruction.prompt;
    practicePhaseStartInstruction.trial_duration = 1500;

    var practicePhaseEndInstruction = allSlides[30];
    delete practicePhaseEndInstruction.choices;
    delete practicePhaseEndInstruction.prompt;
    practicePhaseEndInstruction.trial_duration = 1500;

    var MOOTPhaseStartInstruction = allSlides[33];
    delete MOOTPhaseStartInstruction.choices;
    delete MOOTPhaseStartInstruction.prompt;
    MOOTPhaseStartInstruction.trial_duration = 1500;


    var repeatInstructionChoiceFirst = allSlides[15];
    delete repeatInstructionChoiceFirst.prompt;
    repeatInstructionChoiceFirst.choices = ['ArrowLeft', 'ArrowRight'];

    var repeatInstructionChoiceSecond = allSlides[31];
    delete repeatInstructionChoiceSecond.prompt;
    repeatInstructionChoiceSecond.choices = ['ArrowLeft', 'ArrowRight'];

    var instruction_if_node = {
        timeline: mainInstructions.slice(1),
        conditional_function: function () {
            // get the data from the previous trial,
            // and check which key was pressed
            var last_trial_choice = jsPsych.data.get().last(1).values()[0].response;
            if (last_trial_choice == 'arrowright') {
                return false;
            } if (last_trial_choice == 'arrowleft') {
                return true;
            }
        }

    }
    const practiceInstruction = allSlides[16];
    practiceInstruction.prompt = '<img alt="" src="images/right_arrow.png" width="75" height="50"/>';
    const startInstruction = []
        .concat(generalInstructions).concat(warmup_block).concat(mainInstructions);
    startInstruction.push(repeatInstructionChoiceFirst);
    startInstruction.push(instruction_if_node);
    startInstruction.push(practiceInstruction);

    const questionnaireInstruction = allSlides[39];
    questionnaireInstruction.prompt = '<img alt="" src="images/right_arrow.png" width="75" height="50"/>';
    var questionnaire = allSlides.slice(40, 49);

    const usabilityInstruction = allSlides[49];
    usabilityInstruction.prompt = '<img alt="" src="images/right_arrow.png" width="75" height="50"/>';
    var usabilityQuestionnaire = allSlides.slice(50, 54);
    var usabilityQuestionairePlus = allSlides.slice(55, 66);




    ////////////////////////////////////////////////////
    ////////////////////////////////////////////////////
    ///// Practice test
    ///////////////////////////////////////////////////
    var practice_test_block = practiceFeedBack();
    console.log("practice_test_block", practice_test_block)
    ////////////////////////////////////////////////////
    /////Instruction before PracticeMOOT
    ////////////////////////////////////////////////////    
    instructionBeforePracticeMOOT = [summaryInstruction, practicePhaseStartInstruction].concat(countDown);
    ////////////////////////////////////////////////////
    /////PracticeMOOT
    ////////////////////////////////////////////////////

    const practice_moot_block = createPracticeTimeline();

    ////////////////////////////////////////////////////
    /////Instruction before MOOT
    ////////////////////////////////////////////////////


    var instructionBeforeMOOT = [practicePhaseEndInstruction, repeatInstructionChoiceSecond, instruction_if_node, summaryInstruction, MOOTPhaseStartInstruction]
        .concat(countDown);
    ////////////////////////////////////////////////////
    ////////////////////////////////////////////////////
    //// MOOT
    ////////////////////////////////////////////////////
    ////////////////////////////////////////////////////


    //https://www.geeksforgeeks.org/how-to-shuffle-an-array-using-javascript/
    function shuffleArray(array) {
        for (var i = array.length - 1; i > 0; i--) {

            // Generate random number
            var j = Math.floor(Math.random() * (i + 1));

            var temp = array[i];
            array[i] = array[j];
            array[j] = temp;
        }

        return array;
    }

    // Create the moot blocks V1,...,V4
    const trials_moot_blocks = createMootTimeline();

    ////////////////////////////////////////////////////
    ////////////////////////////////////////////////////
    //// Instruction before Questionnaire
    ////////////////////////////////////////////////////
    ////////////////////////////////////////////////////

    ////////////////////////////////////////////////////
    ////////////////////////////////////////////////////
    //// QUESTIONNAIRE
    ////////////////////////////////////////////////////
    ////////////////////////////////////////////////////

    // questionnaire.unshift(questionnaireInstruction);
    var questionsAgencyOwnership = [];
    for (i = 0; i < questionnaire.length; i++) {
        html_1 = questionnaire[i].stimulus;
        html_2 = questionnaire[i].stimulus;
        if (condition.doppelgaenger_color_white) {
            html_2 = html_2.replaceAll("white", "black");
        } else {
            html_2 = html_2.replaceAll("black", "white");
        }
        if (condition.questionnaire_doppelgaenger_first) {
            // do nothing
        } else {
            [html_1, html_2] = [html_2, html_1];
        }
        questionsAgencyOwnership.push({
            type: jsPsychHtmlSliderResponse,
            stimulus: html_1,
            step: 1,
            labels: ["Fully agree", "Fully disagree"],

        });
        questionsAgencyOwnership.push({
            type: jsPsychHtmlSliderResponse,
            stimulus: html_2,
            step: 1,
            labels: ["Fully agree", "Fully disagree"],

        });
    }
    questionsAgencyOwnership.unshift(questionnaireInstruction);




    ////////////////////////////////////////////////////
    ////////////////////////////////////////////////////
    //// Usability Questions
    ////////////////////////////////////////////////////
    ////////////////////////////////////////////////////

    var usabilityQuestions = [];
    for (i = 0; i < usabilityQuestionnaire.length; i++) {
        html_1 = usabilityQuestionnaire[i].stimulus;
        html_2 = usabilityQuestionnaire[i].stimulus;
        if (condition.doppelgaenger_color_white) {
            html_2 = html_2.replaceAll("white", "black");
        } else {
            html_2 = html_2.replaceAll("black", "white");
        }
        if (condition.questionnaire_doppelgaenger_first) {
            // do nothing
        } else {
            [html_1, html_2] = [html_2, html_1];
        }
        usabilityQuestions.push({
            type: jsPsychHtmlSliderResponse,
            stimulus: html_1,
            step: 1,
            labels: ["Not at all", "Very much"],

        });
        usabilityQuestions.push({
            type: jsPsychHtmlSliderResponse,
            stimulus: html_2,
            step: 1,
            labels: ["Not at all", "Very much"],

        });
    }
    usabilityQuestions.unshift(usabilityInstruction);

    var usabilityQuestionaireExtend = [];
    for (i = 0; i < usabilityQuestionairePlus.length - 2; i++) {
        html = usabilityQuestionairePlus[i].stimulus;
        usabilityQuestionaireExtend.push({
            type: jsPsychHtmlSliderResponse,
            stimulus: html,
            step: 1,
            labels: ["Fully agree", "Fully disagree"],

        });

    }

    var usabilityQuestionaireTextBox = [];
    usabilityQuestionaireTextBox.push({
        type: jsPsychSurveyText,
        questions: [

            {
                prompt: usabilityQuestionairePlus[usabilityQuestionairePlus.length - 2].stimulus.replace(/<[^>]+>/g, ''),
                //required: true,
                placeholder: 'Your text here',
                rows: 3,
                columns: 40,
            }


        ]
    })

    usabilityQuestionaireTextBox.push({
        type: jsPsychSurveyText,
        questions: [

            {
                prompt: usabilityQuestionairePlus[usabilityQuestionairePlus.length - 1].stimulus.replace(/<[^>]+>/g, ''),
                //required: true,
                placeholder: 'Your text here',
                rows: 3,
                columns: 40,
            },



        ],
    })

    var thankYou = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: () => {
            let html = `<h1>Thank You</h1>`;
            return html;
        },
        choices: "NO_KEYS",
        trial_duration: 3000,
    }


    const moot_test = {
        type: jsPsychMootPlugin,
        moot_parameters: {
            doggelgaenger_col: condition.doppelgaenger_color_white ? "1,1,1" : "0,0,0",
            doggelgaenger_loc: condition.doppelgaenger_up ? "20,0,-10" : "-20,0,-10",
            doppelgaenger_target: condition.targetpattern_squares ? "SQ" : "TR",
            go_notarget_left: 1,
            doppelgaenger_anim_rec: experiment_config.record_doppelgaenger_animation,
            other_anim_rec: experiment_config.record_other_animation
        },
        extensions: [
            { type: jsPsychUnityExtension },
            { type: jsPsychExtensionRecordVideo },
            {
                type: jsPsychExtensionMediapipeFacemesh,
                params: {
                    record: false,
                },
            },
        ],
        close_unity_after_trial: false
    }


    ////////////////////////////////////////////////////
    ////////////////////////////////////////////////////
    // Assemble timeline
    //const practiceBlock = [practiceUnitytrial_1, practiceSlider_1, feedback_1, practiceUnitytrial_2, practiceSlider_2, feedback_2, practiceUnitytrial_3, practiceSlider_3, feedback_3, practiceUnitytrial_4, practiceSlider_4, feedback_4, comulativeResponsePercentage, if_node];
    const timeline = [
        preloadMedia,
        // debug_condition, // <--- DEBUGIN ONLY. Remove for data collection
        initCamera,
        enter_fullscreen,

    ]
        // .concat(startInstruction)
        .concat(moot_test)
        // .concat(instructionBeforePracticeMOOT)
        // .concat(practice_moot_block)
        // .concat(instructionBeforeMOOT)
        // .concat(trials_moot_blocks[0])
        // .concat(questionsAgencyOwnership)
        // .concat(usabilityQuestions)
        // .concat(usabilityQuestionaireExtend)
        .concat(usabilityQuestionaireTextBox)
        .concat(exit_fullscreen)
        .concat(thankYou)
        // .concat(nextcloud_upload);

    ////////////////////////////////////////////////////
    ////////////////////////////////////////////////////
    // Run the experiment

    console.log(timeline);

    jsPsych.run(timeline);
</script>

</html>
